<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raktár Információk | EIOP</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --bg-app: #f9f9f9; --bg-panel: #ffffff; --text-main: #1f2937; --text-muted: #6b7280; --border-subtle: #e5e7eb; --accent-color: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); display: flex; flex-direction: column; }
        
        /* HEADER */
        .app-header { flex: 0 0 64px; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-subtle); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .back-btn { display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--text-main); font-weight: 600; font-size: 14px; padding: 8px 16px; border-radius: 8px; transition: background 0.2s; }
        .back-btn:hover { background: #f3f4f6; }
        .page-title { font-weight: 700; font-size: 18px; color: #111827; display: flex; align-items: center; gap: 10px; }
        .last-update-badge { font-size: 12px; color: var(--text-muted); background: #f3f4f6; padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px; font-weight: 500; visibility: hidden; /* Alapból rejtve, hogy ne ugráljon */ }

        /* CONTENT */
        .content-container { flex: 1; padding: 20px 40px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        .stats-grid { flex: 0 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-panel); border-radius: 16px; padding: 20px; border: 1px solid var(--border-subtle); box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; flex-direction: column; gap: 5px; }
        .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: 800; color: #111827; min-height: 29px; } /* Min-height a layout shift ellen */
        
        .table-panel { flex: 1; background: var(--bg-panel); border-radius: 16px; border: 1px solid var(--border-subtle); box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; display: flex; flex-direction: column; }
        .panel-header { flex: 0 0 auto; padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .table-scroll-area { flex: 1; overflow-y: auto; position: relative; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f9fafb; color: var(--text-muted); font-weight: 600; text-align: left; padding: 12px 24px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border-subtle); }
        td { padding: 10px 24px; border-bottom: 1px solid var(--border-subtle); color: var(--text-main); }
        tr:hover { background-color: #f8fafc; }
        .stock-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #d1fae5; color: #065f46; }
        .stock-badge.low { background: #fee2e2; color: #991b1b; }
        
        .table-scroll-area::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-scroll-area::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-scroll-area::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }

        /* INLINE LOADER (A táblázat közepén) */
        .inline-loader-container { padding: 60px; text-align: center; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spin { animation: spin 1s linear infinite; color: var(--accent-color); margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header class="app-header">
        <a href="/" class="back-btn"><i data-lucide="arrow-left" width="18"></i> Vezérlőpult</a>
        <div style="display:flex; align-items:center; gap:20px;">
            <div class="page-title"><i data-lucide="package-search" style="color:var(--accent-color)"></i> Raktárkészlet</div>
            <div id="update-timer" class="last-update-badge">
                <i data-lucide="clock" width="14" style="margin-right:6px;"></i> <span id="timer-text">...</span>
            </div>
        </div>
        <div style="width: 50px;"></div>
    </header>

    <div class="content-container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Összes Termékfajta</div>
                <div class="stat-value" id="stat-count">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Összes Készlet (db)</div>
                <div class="stat-value" id="stat-stock">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Készlet Érték</div>
                <div class="stat-value" id="stat-value">-</div>
            </div>
        </div>

        <div class="table-panel">
            <div class="panel-header">
                <div style="font-weight:700;">Mentett Terméklista</div>
                <button onclick="window.location.href='/';" style="cursor:pointer; border:none; background:none; color:var(--accent-color); font-weight:600; font-size:12px;">
                    <i data-lucide="refresh-cw" width="12" style="vertical-align:middle"></i> Új szinkronizálás
                </button>
            </div>
            <div class="table-scroll-area">
                <table id="inventory-table">
                    <thead>
                        <tr><th>#</th><th>Cikkszám</th><th>Megnevezés</th><th>Készlet</th><th>Nettó Ár</th><th>Vonalkód</th></tr>
                    </thead>
                    <tbody id="table-body">
                        <tr id="loading-row">
                            <td colspan="6">
                                <div class="inline-loader-container">
                                    <i data-lucide="loader-2" width="32" class="spin"></i>
                                    <div>Adatok betöltése...</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        document.addEventListener("DOMContentLoaded", () => {
            fetchCachedData();
        });

        async function fetchCachedData() {
            try {
                // Lekérjük a szerverről a mentett JSON-t
                const response = await fetch('/api/get_inventory_cache');
                const result = await response.json();

                if (result.status === 'success') {
                    // Adatok renderelése (ez automatikusan törli a loading sort)
                    renderTable(result.data);
                    calculateStats(result.data);
                    
                    // Időzítő megjelenítése
                    document.getElementById('update-timer').style.visibility = 'visible';
                    updateTimeDisplay(result.timestamp);
                    setInterval(() => updateTimeDisplay(result.timestamp), 60000);
                } else {
                    if(result.status === 'empty') {
                        // Ha nincs adat, visszaküldjük a főoldalra
                        alert("Még nincs mentett adat. Kérlek futtasd le a szinkronizálást a főoldalon!");
                        window.location.href = '/';
                    }
                }
            } catch (error) {
                console.error("Hiba:", error);
                document.getElementById('table-body').innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:#ef4444;">Hiba történt az adatok betöltésekor.</td></tr>`;
            }
        }

        function updateTimeDisplay(timestamp) {
            const now = Math.floor(Date.now() / 1000);
            const diff = now - timestamp;
            const textEl = document.getElementById('timer-text');
            
            let text = "";
            if (diff < 60) text = "Épp most frissítve";
            else if (diff < 3600) text = `Frissítve: ${Math.floor(diff/60)} perce`;
            else if (diff < 86400) text = `Frissítve: ${Math.floor(diff/3600)} órája`;
            else text = `Frissítve: ${Math.floor(diff/86400)} napja`;
            textEl.innerText = text;
        }

        function renderTable(products) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = ''; // ITT TÖRLI KI A LOADING SORT
            
            const fragment = document.createDocumentFragment();
            
            products.forEach((p, index) => {
                const tr = document.createElement('tr');
                const badgeClass = p.stock < 5 ? 'low' : '';
                tr.innerHTML = `
                    <td style="color:var(--text-muted); font-size:12px;">${index + 1}.</td>
                    <td style="font-family:monospace; font-weight:600; color:var(--accent-color);">${p.sku}</td>
                    <td>${p.name}</td>
                    <td><span class="stock-badge ${badgeClass}">${p.stock} db</span></td>
                    <td style="font-weight:600;">${p.raw_price}</td>
                    <td style="color:var(--text-muted); font-size:12px;">${p.barcode}</td>
                `;
                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        function calculateStats(products) {
            const totalCount = products.length;
            const totalStock = products.reduce((sum, p) => sum + p.stock, 0);
            const totalValue = products.reduce((sum, p) => sum + (p.stock * p.price), 0);
            const fmt = (n) => n.toLocaleString('hu-HU');
            
            document.getElementById('stat-count').innerText = fmt(totalCount);
            document.getElementById('stat-stock').innerText = fmt(totalStock);
            document.getElementById('stat-value').innerText = fmt(totalValue) + " Ft";
        }
    </script>
</body>
</html>