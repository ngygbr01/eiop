<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raktár Információk | EIOP</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-app: #f9f9f9; --bg-panel: #ffffff; --text-main: #1f2937; --text-muted: #6b7280;
            --border-subtle: #e5e7eb; --accent-color: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER */
        .app-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-subtle); padding: 0 24px; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .back-btn { display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--text-main); font-weight: 600; font-size: 14px; padding: 8px 16px; border-radius: 8px; transition: background 0.2s; }
        .back-btn:hover { background: #f3f4f6; }
        .page-title { font-weight: 700; font-size: 18px; color: #111827; display: flex; align-items: center; gap: 10px; }

        /* CONTENT */
        .content-container { padding: 40px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* STATS GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--bg-panel); border-radius: 16px; padding: 24px; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 10px; }
        .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 28px; font-weight: 800; color: #111827; }
        .stat-trend { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 4px; }

        /* TABLE */
        .table-panel { background: var(--bg-panel); border-radius: 16px; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-soft); overflow: hidden; }
        .panel-header { padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .panel-title { font-weight: 700; font-size: 16px; }
        
        .table-container { overflow-x: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f9fafb; color: var(--text-muted); font-weight: 600; text-align: left; padding: 12px 24px; position: sticky; top: 0; border-bottom: 1px solid var(--border-subtle); }
        td { padding: 12px 24px; border-bottom: 1px solid var(--border-subtle); color: var(--text-main); }
        tr:hover { background-color: #f8fafc; }
        
        .stock-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #d1fae5; color: #065f46; }
        .stock-badge.low { background: #fee2e2; color: #991b1b; }

        /* LOADING STATE */
        .loading-overlay { padding: 100px; text-align: center; color: var(--text-muted); }
        .spin { animation: spin 1s linear infinite; color: var(--accent-color); margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header class="app-header">
        <a href="/" class="back-btn"><i data-lucide="arrow-left" width="18"></i> Vezérlőpult</a>
        <div class="page-title"><i data-lucide="package-search" style="color:var(--accent-color)"></i> Raktárkészlet</div>
        <div style="width: 100px;"></div>
    </header>

    <div class="content-container">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Összes Termékfajta</div>
                <div class="stat-value" id="stat-count">-</div>
                <div class="stat-trend" style="color:var(--text-muted)">Raktáron lévő tételek</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Összes Készlet (db)</div>
                <div class="stat-value" id="stat-stock">-</div>
                <div class="stat-trend" style="color:var(--success)"><i data-lucide="package"></i> darab</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Készlet Érték (Becsült)</div>
                <div class="stat-value" id="stat-value">-</div>
                <div class="stat-trend" style="color:var(--accent-color)">HUF</div>
            </div>
        </div>

        <div class="table-panel">
            <div class="panel-header">
                <div class="panel-title">Terméklista (SZVG Tools)</div>
                <button onclick="window.location.reload()" style="cursor:pointer; border:none; background:none; color:var(--accent-color); font-weight:600;">Frissítés</button>
            </div>
            
            <div class="table-container">
                <div id="loading-indicator" class="loading-overlay">
                    <i data-lucide="loader-2" width="48" class="spin"></i>
                    <p>Adatok lekérése a webshopból...</p>
                </div>

                <table id="inventory-table" style="display:none;">
                    <thead>
                        <tr>
                            <th>Cikkszám</th>
                            <th>Megnevezés</th>
                            <th>Készlet</th>
                            <th>Nettó Ár</th>
                            <th>Vonalkód</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        document.addEventListener("DOMContentLoaded", () => {
            loadDataFromStorage();
        });

        function loadDataFromStorage() {
            // Megnézzük, hoztunk-e adatot az előző oldalról
            const storedData = sessionStorage.getItem('inventoryData');

            if (storedData) {
                // HA VAN ADAT: Azonnal megjelenítjük
                const data = JSON.parse(storedData);
                console.log("Adatok betöltve a gyorsítótárból.");
                
                // UI kezelés
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('inventory-table').style.display = 'table';
                
                renderTable(data);
                calculateStats(data);
                
                // Opcionális: Törölhetjük a storage-ot, ha azt akarjuk, hogy frissítéskor újratöltsön,
                // de jobb meghagyni, hogy F5-re ne vesszen el.
            } else {
                // HA NINCS ADAT (pl. direkt linkkel nyitották meg): Lekérjük újra
                console.log("Nincs gyorsítótár, letöltés indítása...");
                fetchData();
            }
        }

        // Ez a "fallback" függvény, ha nincs adat a memóriában
        async function fetchData() {
            document.getElementById('loading-indicator').style.display = 'block';
            try {
                const response = await fetch('/api/get_inventory');
                const result = await response.json();

                if (result.status === 'success') {
                    sessionStorage.setItem('inventoryData', JSON.stringify(result.data)); // Mentjük a jövőre
                    renderTable(result.data);
                    calculateStats(result.data);
                } else {
                    alert("Hiba történt: " + result.message);
                }
            } catch (error) {
                console.error(error);
                alert("Hálózati hiba!");
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('inventory-table').style.display = 'table';
            }
        }

        function renderTable(products) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            products.forEach(p => {
                const tr = document.createElement('tr');
                const badgeClass = p.stock < 5 ? 'low' : '';
                
                tr.innerHTML = `
                    <td style="font-family:monospace; font-weight:600;">${p.sku}</td>
                    <td>${p.name}</td>
                    <td><span class="stock-badge ${badgeClass}">${p.stock} db</span></td>
                    <td>${p.raw_price}</td>
                    <td style="color:var(--text-muted); font-size:12px;">${p.barcode}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calculateStats(products) {
            const totalCount = products.length;
            const totalStock = products.reduce((sum, p) => sum + p.stock, 0);
            const totalValue = products.reduce((sum, p) => sum + (p.stock * p.price), 0);
            const fmt = (n) => n.toLocaleString('hu-HU');

            document.getElementById('stat-count').innerText = fmt(totalCount);
            document.getElementById('stat-stock').innerText = fmt(totalStock);
            document.getElementById('stat-value').innerText = fmt(totalValue) + " Ft";
        }
    </script>
</body>
</html>